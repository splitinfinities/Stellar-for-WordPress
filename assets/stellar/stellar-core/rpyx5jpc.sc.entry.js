const e=window.StellarCore.h;import{a as t,b as n}from"./chunk-7646164d.js";import{a as r}from"./chunk-340b8099.js";import"./chunk-9f751763.js";import{a as i}from"./chunk-a955a305.js";import"./chunk-5ce278cb.js";import{a as s}from"./chunk-f527ab08.js";import{b as a}from"./chunk-13dbd937.js";import{a as o}from"./chunk-ee695030.js";class u{constructor(){this.randomId=Math.floor(6*Math.random())+1,this.debug=!1,this.color="gray",this.playing=!1,this.width=800,this.height=800,this.aspectRatio=100,this.loaded=!1,this.loading=!1,this.duration=1,this.current=0,this.cache=new WeakMap,this.difference=((e,t)=>Math.abs(e-t)),this.limit=((e,t,n)=>Math.max(Math.min(n,t),e)),this.interval=((e,t,n)=>this.difference(e,n)/this.difference(e,t)),this.interpolate=((e,t,n)=>{const r=this.difference(e,t)*n;return e>t?e-r:e+r})}componentWillLoad(){r.set({"--width":`${this.width}px`,"--height":`${this.height}px`,"--aspectRatio":`${this.aspectRatio}%`},this.element)}componentDidLoad(){this.update_interview_lines(),this.audio=this.element.querySelector("web-audio"),this.addIntersectionObserver()}addIntersectionObserver(){"IntersectionObserver"in window&&(this.io=new IntersectionObserver(e=>{e[0].isIntersecting||this.handleOffScreen()},{threshold:[0]}),this.io.observe(this.element))}handleTimeUpdate(e){this.current=Math.round(1e3*e.detail.time),this.duration=Math.round(1e3*e.detail.duration),this.update_interview_lines()}get_interview_lines(){const e=Array.from(this.element.querySelectorAll(".line"));return this.interviewLines=e.map(e=>{const t=parseInt(e.dataset.end,10),n=parseInt(e.dataset.start,10),r=parseFloat(e.dataset.opacityStart),i=parseFloat(e.dataset.opacityEnd),s=parseInt(e.dataset.translatexStart,10),a=parseInt(e.dataset.translatexEnd,10),o=parseInt(e.dataset.translateyStart,10),u=parseInt(e.dataset.translateyEnd,10),h=parseFloat(e.dataset.scaleStart),l=parseFloat(e.dataset.scaleEnd),c={};return isNaN(r)||isNaN(i)||(c.opacity={end:i,start:r}),isNaN(s)||isNaN(a)||(c.translateX={end:a,start:s}),isNaN(o)||isNaN(u)||(c.translateY={end:u,start:o}),isNaN(h)||isNaN(l)||(c.scale={end:l,start:h}),void 0===t||void 0===n||0===Object.keys(c).length?null:{el:e,end:t,offset:0,start:n,updates:c}}).filter(e=>e),this.interviewLines}update_interview_lines(){const e=this.prefixedTransformProp(),t=this.time();this.get_interview_lines().map(({el:n,end:r,offset:i,start:s,updates:a})=>{const o=i+s,u=i+r,h=this.cache.get(n);if(t>=o&&t<=u||"before"!==h&&t<o||"after"!==h&&t>u){let r=0,i=0,s=1;const h=this.limit(o,u,t),l=this.interval(o,u,h);if(a.opacity){const{end:e,start:t}=a.opacity,r=this.interpolate(t,e,l).toFixed(2);n.style.opacity=r}if(a.translateX){const{end:e,start:t}=a.translateX;r=parseInt(this.interpolate(t,e,l),10)}if(a.translateY){const{end:e,start:t}=a.translateY;i=parseInt(this.interpolate(t,e,l),10)}if(a.scale){const{end:e,start:t}=a.scale;s=this.interpolate(t,e,l).toFixed(2)}n.style[e]=`translate3d(${r}px, ${i}px, 0) scale(${s})`,this.cache.set(n,t<o?"before":t>u?"after":"during")}})}prefixedTransformProp(){const e=document.createElement("div"),t=["Webkit","webkit","Moz","moz","ms","o"];if(null!=e.style.transform)return"transform";for(let n in t){const r=`${t[n]}Transform`;if(void 0!==e.style[r])return r}}time(){return this.current}handleInScreen(e=(()=>{})){this.loading=!0,this.loaded||this.audio.is_prepared()||this.audio.connect_the_world().then(()=>{this.loaded=!0,setTimeout(()=>{this.loading=!1,this.audio.source("interview").prepare(),this.duration=Math.round(1e3*this.audio.source("interview").getDuration()),e()},1e3)})}async handleOffScreen(){this.pause()}play(){this.audio&&(this.audio.source("interview")&&this.audio.source("interview").play(),this.playing=this.audio.source("interview").playing)}skipTo(e){this.audio&&(this.audio.source("interview")&&this.audio.source("interview").skipTo(e),this.playing=this.audio.source("interview").playing)}pause(){this.audio&&(this.audio.source("interview")&&this.audio.source("interview").pause(),this.playing=this.audio.source("interview").playing)}toggle(){this.audio&&(this.audio.source("interview")&&this.audio.source("interview").toggle(),this.playing=this.audio.source("interview").playing)}handleClick(){this.audio.is_prepared()?this.toggle():this.handleInScreen(()=>{this.handleClick()}),this.current===this.duration&&this.skipTo(0)}handleCurrentClick(){s.copyPlain(this.current)}render(){return e("div",{class:"card",onDblClick:()=>{this.handleClick()}},e("section",null,e("slot",null),e("div",{class:"transcript"},e("slot",{name:"transcript"})),e("web-audio",{name:`interview-${this.randomId}`},e("web-audio-source",{src:this.src,name:"interview"})),this.debug&&e("web-audio-debugger",null),e("web-audio-visualizer",{for:`interview-${this.randomId}`,type:"bars",color:this.color}),e("button",{class:this.loading?"loading button":this.playing?"playing button":"button",onClick:()=>{this.handleClick()}},e("stellar-asset",{name:this.loading?"sync":this.playing?"pause":"play",class:this.loading?"animation-spin":""})),e("h3",null,e("stellar-unit",{class:"current",value:this.current,from:"ms",to:"s",onClick:()=>{this.handleCurrentClick()}})),e("h3",null,e("stellar-unit",{class:"duration",value:this.duration,from:"ms",to:"s"})),e("stellar-progress",{value:this.current,max:this.duration,noease:!0,blurable:!1,slender:!0,editable:!0,onValueChange:e=>{this.skipTo(e.detail.value)}})))}static get is(){return"stellar-interview"}static get properties(){return{aspectRatio:{type:Number,attr:"aspect-ratio",mutable:!0},audio:{state:!0},color:{type:String,attr:"color"},current:{state:!0},debug:{type:Boolean,attr:"debug"},duration:{state:!0},element:{elementRef:!0},height:{type:Number,attr:"height",mutable:!0},interviewLines:{state:!0},io:{state:!0},loaded:{state:!0},loading:{state:!0},pause:{method:!0},play:{method:!0},playing:{type:Boolean,attr:"playing",mutable:!0},randomId:{state:!0},skipTo:{method:!0},src:{type:String,attr:"src"},toggle:{method:!0},updateFunc:{state:!0},width:{type:Number,attr:"width",mutable:!0}}}static get listeners(){return[{name:"timeupdate",method:"handleTimeUpdate"}]}static get style(){return"stellar-interview{--width:800px;--height:800px;display:block}stellar-interview div.card{position:relative;display:block;width:auto;height:auto;margin:auto;overflow:hidden}stellar-interview div.card section{height:inherit;display:block;position:relative;padding-top:0!important}stellar-interview web-audio-visualizer[type=bars]{position:absolute;top:auto;left:0;right:0;bottom:0;width:100%;height:60%;pointer-events:none;z-index:2}stellar-interview stellar-360-image,stellar-interview stellar-360-video,stellar-interview stellar-image,stellar-interview stellar-video{--gradient:radial-gradient(circle at 30% 107%,var(--theme-base5) 0%,var(--theme-base8) 5%,var(--theme-complement8) 45%,var(--theme-complement5) 60%,var(--theme-base5) 90%);position:relative;z-index:1;display:block}stellar-interview stellar-progress{position:absolute;top:0;left:0;width:100%;z-index:9}stellar-interview stellar-progress .progress{border:0}stellar-interview stellar-unit{position:absolute;bottom:1rem;z-index:2;color:#fff!important;font-weight:700}stellar-interview stellar-unit.current{left:1rem}stellar-interview stellar-unit.duration{right:1rem}stellar-interview .transcript{position:absolute;bottom:0;width:70%;left:15%;z-index:5;pointer-events:none}stellar-interview .button{position:absolute;-webkit-transition:all .35s var(--ease) 0s,background .175s var(--ease) 0s;transition:all .35s var(--ease) 0s,background .175s var(--ease) 0s;width:9rem;height:9rem;top:50%;right:50%;-webkit-transform:translate(50%,-50%);transform:translate(50%,-50%);border-radius:100%;padding:0;border:0;z-index:3;-webkit-appearance:none;-moz-appearance:none;appearance:none;background:#fff;text-align:center;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;z-index:4;outline:0;cursor:pointer;padding-left:1rem;mix-blend-mode:soft-light}stellar-interview .button:focus,stellar-interview .button:hover{-webkit-transform:translate(50%,-50%) scale(1.1);transform:translate(50%,-50%) scale(1.1);mix-blend-mode:hard-light}stellar-interview .button stellar-asset{font-size:7rem;margin:auto;display:block}stellar-interview .button.loading{padding:0}stellar-interview .button.playing{width:2.8rem;height:2.8rem;top:2.2rem;right:1.8rem;padding:0;background:transparent;-webkit-transition:all .35s var(--ease) 0s,background .175s var(--ease) 0s;transition:all .35s var(--ease) 0s,background .175s var(--ease) 0s}stellar-interview .button.playing stellar-asset{font-size:2.8rem}"}}class h{constructor(){this.slender=!1,this.max=100,this.editable=!1,this.noease=!1,this.rounded=!1,this.value=0,this.blurable=!0,this.wrapper="stellar-blur",this.blur=0,this.ease=i({end:20,start:-1,duration:200,tick:e=>{this.blur=e.value},complete:()=>{this.blur=0,this.ease.stop()}})}componentWillLoad(){this.blurable||(this.wrapper="div")}observeValue(){this.blurable&&this.ease.start()}handleClick(e){if(this.editable){var t=this.element.getBoundingClientRect(),n=e.pageX-t.left,r=t.width,i=n/r*this.max,s=Math.round(100*i)/100;console.log(`bounding: ${t}`),console.log(`widthClicked: ${n}`),console.log(`totalWidth: ${r}`),console.log(`max: ${this.max}`),console.log(`calc: ${i}`),console.log(`rounded: ${s}`),this.rounded&&(s=Math.ceil(s)),this.value=s,this.valueChange.emit({value:this.value})}}progress(){let e=this.value/this.max*100;return(e=e<100?e:100)>0?e:0}render(){return e(this.wrapper,{class:"progress",horizontal:this.blur,onClick:e=>{this.handleClick(e)}},e("div",{class:"status",style:{transform:`translate(${this.progress()}%, 0)`}}))}static get is(){return"stellar-progress"}static get encapsulation(){return"shadow"}static get properties(){return{blur:{state:!0},blurable:{type:Boolean,attr:"blurable"},ease:{state:!0},editable:{type:Boolean,attr:"editable",reflectToAttr:!0},element:{elementRef:!0},max:{type:Number,attr:"max",reflectToAttr:!0},noease:{type:Boolean,attr:"noease",reflectToAttr:!0},rounded:{type:Boolean,attr:"rounded",reflectToAttr:!0},slender:{type:Boolean,attr:"slender",reflectToAttr:!0},value:{type:Number,attr:"value",reflectToAttr:!0,mutable:!0,watchCallbacks:["observeValue"]},wrapper:{state:!0}}}static get events(){return[{name:"valueChange",method:"valueChange",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return".sc-stellar-progress-h, .sc-stellar-progress-h   *.sc-stellar-progress, .sc-stellar-progress-h   .sc-stellar-progress:after, .sc-stellar-progress-h   .sc-stellar-progress:before{-webkit-box-sizing:border-box;box-sizing:border-box}.sc-stellar-progress-h{display:block;position:relative;overflow:hidden;--border-radius:0.3rem}.sc-stellar-progress-h   .blur-content.sc-stellar-progress{display:block;height:100%}[editable].sc-stellar-progress-h{cursor:pointer}.sc-stellar-progress-h   .progress.sc-stellar-progress{display:block;position:relative;-webkit-transition:all .25s var(--ease) 0ms;transition:all .25s var(--ease) 0ms;background:var(--gray1);width:100%;height:.6rem;border-radius:var(--border-radius);overflow:hidden}[editable].sc-stellar-progress-h:hover   .progress.sc-stellar-progress{height:2.4rem}.sc-stellar-progress-h   .status.sc-stellar-progress{position:absolute;top:0;right:0;bottom:0;left:-100%;-webkit-transition:all .35s var(--ease,ease-in-out) 0ms;transition:all .35s var(--ease,ease-in-out) 0ms;background:var(--theme-base5,var(--gray5));width:100%}[slender].sc-stellar-progress-h   .progress.sc-stellar-progress{border:0;height:.2rem}[slender][editable].sc-stellar-progress-h:hover   .progress.sc-stellar-progress{height:.4rem}[noease].sc-stellar-progress-h   .progress.sc-stellar-progress, [noease].sc-stellar-progress-h   .status.sc-stellar-progress{-webkit-transition:none!important;transition:none!important}.dark-mode.sc-stellar-progress-h -no-combinator.sc-stellar-progress-h   .progress.sc-stellar-progress, .dark-mode   .sc-stellar-progress-h -no-combinator.sc-stellar-progress-h   .progress.sc-stellar-progress{background:var(--theme-base9)}"}}class l{constructor(){this.history=[],this.count=50}addHistory(e){let t=[e,...this.history];this.history=t.length>this.count?t.slice(1,this.count):t}render(){return e("div",null,this.history.map(t=>e("div",null,e("p",null,t))))}static get is(){return"web-audio-debugger"}static get encapsulation(){return"shadow"}static get properties(){return{addHistory:{method:!0},count:{type:Number,attr:"count"},history:{state:!0}}}static get style(){return"web-audio-debugger.sc-web-audio-debugger{display:block;position:fixed;top:0;right:0;width:160px;height:300px;overflow:auto;text-align:right;padding:1rem;border:2px solid #000}web-audio-debugger.sc-web-audio-debugger   p.sc-web-audio-debugger{font-size:12px;margin:0 0 1em 0}"}}class c{constructor(e,t,n){this.loadBuffer=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer";var r=this;n.onload=function(){r.context.decodeAudioData(n.response,function(n){n?(r.bufferList[t]=n,++r.loadCount==r.urlList.length&&r.onload(r.bufferList)):alert("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()},this.load=function(){for(var e=0;e<this.urlList.length;++e)this.loadBuffer(this.urlList[e],e)},this.context=e,this.urlList=t,this.onload=n,this.bufferList=new Array,this.loadCount=0}}var d=t(function(e){!function(t){function n(){if(n.prototype._singleton)throw new Error("WebMidi is a singleton, it cannot be instantiated directly.");n.prototype._singleton=this,this._inputs=[],this._outputs=[],this._userHandlers={},this._stateChangeQueue=[],this._processingStateChange=!1,this._midiInterfaceEvents=["connected","disconnected"],this._notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this._semitones={C:0,D:2,E:4,F:5,G:7,A:9,B:11},Object.defineProperties(this,{MIDI_SYSTEM_MESSAGES:{value:{sysex:240,timecode:241,songposition:242,songselect:243,tuningrequest:246,sysexend:247,clock:248,start:250,continue:251,stop:252,activesensing:254,reset:255,midimessage:0,unknownsystemmessage:-1},writable:!1,enumerable:!0,configurable:!1},MIDI_CHANNEL_MESSAGES:{value:{noteoff:8,noteon:9,keyaftertouch:10,controlchange:11,channelmode:11,programchange:12,channelaftertouch:13,pitchbend:14},writable:!1,enumerable:!0,configurable:!1},MIDI_REGISTERED_PARAMETER:{value:{pitchbendrange:[0,0],channelfinetuning:[0,1],channelcoarsetuning:[0,2],tuningprogram:[0,3],tuningbank:[0,4],modulationrange:[0,5],azimuthangle:[61,0],elevationangle:[61,1],gain:[61,2],distanceratio:[61,3],maximumdistance:[61,4],maximumdistancegain:[61,5],referencedistanceratio:[61,6],panspreadangle:[61,7],rollangle:[61,8]},writable:!1,enumerable:!0,configurable:!1},MIDI_CONTROL_CHANGE_MESSAGES:{value:{bankselectcoarse:0,modulationwheelcoarse:1,breathcontrollercoarse:2,footcontrollercoarse:4,portamentotimecoarse:5,dataentrycoarse:6,volumecoarse:7,balancecoarse:8,pancoarse:10,expressioncoarse:11,effectcontrol1coarse:12,effectcontrol2coarse:13,generalpurposeslider1:16,generalpurposeslider2:17,generalpurposeslider3:18,generalpurposeslider4:19,bankselectfine:32,modulationwheelfine:33,breathcontrollerfine:34,footcontrollerfine:36,portamentotimefine:37,dataentryfine:38,volumefine:39,balancefine:40,panfine:42,expressionfine:43,effectcontrol1fine:44,effectcontrol2fine:45,holdpedal:64,portamento:65,sustenutopedal:66,softpedal:67,legatopedal:68,hold2pedal:69,soundvariation:70,resonance:71,soundreleasetime:72,soundattacktime:73,brightness:74,soundcontrol6:75,soundcontrol7:76,soundcontrol8:77,soundcontrol9:78,soundcontrol10:79,generalpurposebutton1:80,generalpurposebutton2:81,generalpurposebutton3:82,generalpurposebutton4:83,reverblevel:91,tremololevel:92,choruslevel:93,celestelevel:94,phaserlevel:95,databuttonincrement:96,databuttondecrement:97,nonregisteredparametercoarse:98,nonregisteredparameterfine:99,registeredparametercoarse:100,registeredparameterfine:101},writable:!1,enumerable:!0,configurable:!1},MIDI_CHANNEL_MODE_MESSAGES:{value:{allsoundoff:120,resetallcontrollers:121,localcontrol:122,allnotesoff:123,omnimodeoff:124,omnimodeon:125,monomodeon:126,polymodeon:127},writable:!1,enumerable:!0,configurable:!1},octaveOffset:{value:0,writable:!0,enumerable:!0,configurable:!1}}),Object.defineProperties(this,{supported:{enumerable:!0,get:function(){return"requestMIDIAccess"in navigator}},enabled:{enumerable:!0,get:function(){return void 0!==this.interface}.bind(this)},inputs:{enumerable:!0,get:function(){return this._inputs}.bind(this)},outputs:{enumerable:!0,get:function(){return this._outputs}.bind(this)},sysexEnabled:{enumerable:!0,get:function(){return!(!this.interface||!this.interface.sysexEnabled)}.bind(this)},time:{enumerable:!0,get:function(){return performance.now()}}})}function r(e){var t=this;this._userHandlers={channel:{},system:{}},this._midiInput=e,Object.defineProperties(this,{connection:{enumerable:!0,get:function(){return t._midiInput.connection}},id:{enumerable:!0,get:function(){return t._midiInput.id}},manufacturer:{enumerable:!0,get:function(){return t._midiInput.manufacturer}},name:{enumerable:!0,get:function(){return t._midiInput.name}},state:{enumerable:!0,get:function(){return t._midiInput.state}},type:{enumerable:!0,get:function(){return t._midiInput.type}}}),this._initializeUserHandlers(),this._midiInput.onmidimessage=this._onMidiMessage.bind(this)}function i(e){var t=this;this._midiOutput=e,Object.defineProperties(this,{connection:{enumerable:!0,get:function(){return t._midiOutput.connection}},id:{enumerable:!0,get:function(){return t._midiOutput.id}},manufacturer:{enumerable:!0,get:function(){return t._midiOutput.manufacturer}},name:{enumerable:!0,get:function(){return t._midiOutput.name}},state:{enumerable:!0,get:function(){return t._midiOutput.state}},type:{enumerable:!0,get:function(){return t._midiOutput.type}}})}var s=new n;n.prototype.enable=function(e,t){return this.enabled?void 0:this.supported?void navigator.requestMIDIAccess({sysex:t}).then(function(t){function n(){clearTimeout(r),this._updateInputsAndOutputs(),this.interface.onstatechange=this._onInterfaceStateChange.bind(this),"function"==typeof e&&e.call(this),i.forEach(function(e){this._onInterfaceStateChange(e)}.bind(this))}var r,i=[],s=[];this.interface=t,this._resetInterfaceUserHandlers(),this.interface.onstatechange=function(e){i.push(e)};for(var a=t.inputs.values(),o=a.next();o&&!o.done;o=a.next())s.push(o.value.open());for(var u=t.outputs.values(),h=u.next();h&&!h.done;h=u.next())s.push(h.value.open());r=setTimeout(n.bind(this),200),Promise&&Promise.all(s).catch(function(e){}).then(n.bind(this))}.bind(this),function(t){"function"==typeof e&&e.call(this,t)}.bind(this)):void("function"==typeof e&&e(new Error("The Web MIDI API is not supported by your browser.")))},n.prototype.disable=function(){if(!this.supported)throw new Error("The Web MIDI API is not supported by your browser.");this.interface&&(this.interface.onstatechange=void 0),this.interface=void 0,this._inputs=[],this._outputs=[],this._resetInterfaceUserHandlers()},n.prototype.addListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before adding event listeners.");if("function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(!(this._midiInterfaceEvents.indexOf(e)>=0))throw new TypeError("The specified event type is not supported.");return this._userHandlers[e].push(t),this},n.prototype.hasListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before checking event listeners.");if("function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(!(this._midiInterfaceEvents.indexOf(e)>=0))throw new TypeError("The specified event type is not supported.");for(var n=0;n<this._userHandlers[e].length;n++)if(this._userHandlers[e][n]===t)return!0;return!1},n.prototype.removeListener=function(e,t){if(!this.enabled)throw new Error("WebMidi must be enabled before removing event listeners.");if(void 0!==t&&"function"!=typeof t)throw new TypeError("The 'listener' parameter must be a function.");if(this._midiInterfaceEvents.indexOf(e)>=0)if(t)for(var n=0;n<this._userHandlers[e].length;n++)this._userHandlers[e][n]===t&&this._userHandlers[e].splice(n,1);else this._userHandlers[e]=[];else{if(void 0!==e)throw new TypeError("The specified event type is not supported.");this._resetInterfaceUserHandlers()}return this},n.prototype.toMIDIChannels=function(e){var t;return(t="all"===e||void 0===e?["all"]:Array.isArray(e)?e:[e]).indexOf("all")>-1&&(t=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),t.map(function(e){return parseInt(e)}).filter(function(e){return e>=1&&16>=e})},n.prototype.getInputById=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");e=String(e);for(var t=0;t<this.inputs.length;t++)if(this.inputs[t].id===e)return this.inputs[t];return!1},n.prototype.getOutputById=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");e=String(e);for(var t=0;t<this.outputs.length;t++)if(this.outputs[t].id===e)return this.outputs[t];return!1},n.prototype.getInputByName=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");for(var t=0;t<this.inputs.length;t++)if(~this.inputs[t].name.indexOf(e))return this.inputs[t];return!1},n.prototype.getOctave=function(e){return null!=e&&e>=0&&127>=e?Math.floor(Math.floor(e)/12-1)+Math.floor(s.octaveOffset):void 0},n.prototype.getOutputByName=function(e){if(!this.enabled)throw new Error("WebMidi is not enabled.");for(var t=0;t<this.outputs.length;t++)if(~this.outputs[t].name.indexOf(e))return this.outputs[t];return!1},n.prototype.guessNoteNumber=function(e){var t=!1;if(e&&e.toFixed&&e>=0&&127>=e?t=Math.round(e):parseInt(e)>=0&&parseInt(e)<=127?t=parseInt(e):("string"==typeof e||e instanceof String)&&(t=this.noteNameToNumber(e)),!1===t)throw new Error("Invalid input value ("+e+").");return t},n.prototype.noteNameToNumber=function(e){"string"!=typeof e&&(e="");var t=e.match(/([CDEFGAB])(#{0,2}|b{0,2})(-?\d+)/i);if(!t)throw new RangeError("Invalid note name.");var n=s._semitones[t[1].toUpperCase()],r=12*(parseInt(t[3])+1-Math.floor(s.octaveOffset))+n;if(t[2].toLowerCase().indexOf("b")>-1?r-=t[2].length:t[2].toLowerCase().indexOf("#")>-1&&(r+=t[2].length),0>r||r>127)throw new RangeError("Invalid note name or note outside valid range.");return r},n.prototype._updateInputsAndOutputs=function(){this._updateInputs(),this._updateOutputs()},n.prototype._updateInputs=function(){for(var e=0;e<this._inputs.length;e++){for(var t=!0,n=this.interface.inputs.values(),i=n.next();i&&!i.done;i=n.next())if(this._inputs[e]._midiInput===i.value){t=!1;break}t&&this._inputs.splice(e,1)}this.interface&&this.interface.inputs.forEach(function(e){for(var t=!0,n=0;n<this._inputs.length;n++)this._inputs[n]._midiInput===e&&(t=!1);t&&this._inputs.push(new r(e))}.bind(this))},n.prototype._updateOutputs=function(){for(var e=0;e<this._outputs.length;e++){for(var t=!0,n=this.interface.outputs.values(),r=n.next();r&&!r.done;r=n.next())if(this._outputs[e]._midiOutput===r.value){t=!1;break}t&&this._outputs.splice(e,1)}this.interface&&this.interface.outputs.forEach(function(e){for(var t=!0,n=0;n<this._outputs.length;n++)this._outputs[n]._midiOutput===e&&(t=!1);t&&this._outputs.push(new i(e))}.bind(this))},n.prototype._onInterfaceStateChange=function(e){this._updateInputsAndOutputs();var t={timestamp:e.timeStamp,type:e.port.state};this.interface&&"connected"===e.port.state?"output"===e.port.type?t.port=this.getOutputById(e.port.id):"input"===e.port.type&&(t.port=this.getInputById(e.port.id)):t.port={connection:"closed",id:e.port.id,manufacturer:e.port.manufacturer,name:e.port.name,state:e.port.state,type:e.port.type},this._userHandlers[e.port.state].forEach(function(e){e(t)})},n.prototype._resetInterfaceUserHandlers=function(){for(var e=0;e<this._midiInterfaceEvents.length;e++)this._userHandlers[this._midiInterfaceEvents[e]]=[]},r.prototype.on=r.prototype.addListener=function(e,t,n){var r=this;if(void 0===t&&(t="all"),Array.isArray(t)||(t=[t]),t.forEach(function(e){if("all"!==e&&!(e>=1&&16>=e))throw new RangeError("The 'channel' parameter is invalid.")}),"function"!=typeof n)throw new TypeError("The 'listener' parameter must be a function.");if(void 0!==s.MIDI_SYSTEM_MESSAGES[e])this._userHandlers.system[e]||(this._userHandlers.system[e]=[]),this._userHandlers.system[e].push(n);else{if(void 0===s.MIDI_CHANNEL_MESSAGES[e])throw new TypeError("The specified event type is not supported.");if(t.indexOf("all")>-1){t=[];for(var i=1;16>=i;i++)t.push(i)}this._userHandlers.channel[e]||(this._userHandlers.channel[e]=[]),t.forEach(function(t){r._userHandlers.channel[e][t]||(r._userHandlers.channel[e][t]=[]),r._userHandlers.channel[e][t].push(n)})}return this},r.prototype.hasListener=function(e,t,n){var r=this;if("function"!=typeof n)throw new TypeError("The 'listener' parameter must be a function.");if(void 0===t&&(t="all"),t.constructor!==Array&&(t=[t]),void 0!==s.MIDI_SYSTEM_MESSAGES[e]){for(var i=0;i<this._userHandlers.system[e].length;i++)if(this._userHandlers.system[e][i]===n)return!0}else if(void 0!==s.MIDI_CHANNEL_MESSAGES[e]){if(t.indexOf("all")>-1){t=[];for(var a=1;16>=a;a++)t.push(a)}return!!this._userHandlers.channel[e]&&t.every(function(t){var i=r._userHandlers.channel[e][t];return i&&i.indexOf(n)>-1})}return!1},r.prototype.removeListener=function(e,t,n){var r=this;if(void 0!==n&&"function"!=typeof n)throw new TypeError("The 'listener' parameter must be a function.");if(void 0===t&&(t="all"),t.constructor!==Array&&(t=[t]),void 0!==s.MIDI_SYSTEM_MESSAGES[e])if(void 0===n)this._userHandlers.system[e]=[];else for(var i=0;i<this._userHandlers.system[e].length;i++)this._userHandlers.system[e][i]===n&&this._userHandlers.system[e].splice(i,1);else if(void 0!==s.MIDI_CHANNEL_MESSAGES[e]){if(t.indexOf("all")>-1){t=[];for(var a=1;16>=a;a++)t.push(a)}if(!this._userHandlers.channel[e])return this;t.forEach(function(t){var i=r._userHandlers.channel[e][t];if(i)if(void 0===n)r._userHandlers.channel[e][t]=[];else for(var s=0;s<i.length;s++)i[s]===n&&i.splice(s,1)})}else{if(void 0!==e)throw new TypeError("The specified event type is not supported.");this._initializeUserHandlers()}return this},r.prototype._initializeUserHandlers=function(){for(var e in s.MIDI_CHANNEL_MESSAGES)s.MIDI_CHANNEL_MESSAGES.hasOwnProperty(e)&&(this._userHandlers.channel[e]={});for(var t in s.MIDI_SYSTEM_MESSAGES)s.MIDI_SYSTEM_MESSAGES.hasOwnProperty(t)&&(this._userHandlers.system[t]=[])},r.prototype._onMidiMessage=function(e){if(this._userHandlers.system.midimessage.length>0){var t={target:this,data:e.data,timestamp:e.timeStamp,type:"midimessage"};this._userHandlers.system.midimessage.forEach(function(e){e(t)})}e.data[0]<240?this._parseChannelEvent(e):e.data[0]<=255&&this._parseSystemEvent(e)},r.prototype._parseChannelEvent=function(e){var t,n,r=e.data[0]>>4,i=1+(15&e.data[0]);e.data.length>1&&(t=e.data[1],n=e.data.length>2?e.data[2]:void 0);var a={target:this,data:e.data,timestamp:e.timeStamp,channel:i};r===s.MIDI_CHANNEL_MESSAGES.noteoff||r===s.MIDI_CHANNEL_MESSAGES.noteon&&0===n?(a.type="noteoff",a.note={number:t,name:s._notes[t%12],octave:s.getOctave(t)},a.velocity=n/127,a.rawVelocity=n):r===s.MIDI_CHANNEL_MESSAGES.noteon?(a.type="noteon",a.note={number:t,name:s._notes[t%12],octave:s.getOctave(t)},a.velocity=n/127,a.rawVelocity=n):r===s.MIDI_CHANNEL_MESSAGES.keyaftertouch?(a.type="keyaftertouch",a.note={number:t,name:s._notes[t%12],octave:s.getOctave(t)},a.value=n/127):r===s.MIDI_CHANNEL_MESSAGES.controlchange&&t>=0&&119>=t?(a.type="controlchange",a.controller={number:t,name:this.getCcNameByNumber(t)},a.value=n):r===s.MIDI_CHANNEL_MESSAGES.channelmode&&t>=120&&127>=t?(a.type="channelmode",a.controller={number:t,name:this.getChannelModeByNumber(t)},a.value=n):r===s.MIDI_CHANNEL_MESSAGES.programchange?(a.type="programchange",a.value=t):r===s.MIDI_CHANNEL_MESSAGES.channelaftertouch?(a.type="channelaftertouch",a.value=t/127):r===s.MIDI_CHANNEL_MESSAGES.pitchbend?(a.type="pitchbend",a.value=((n<<7)+t-8192)/8192):a.type="unknownchannelmessage",this._userHandlers.channel[a.type]&&this._userHandlers.channel[a.type][i]&&this._userHandlers.channel[a.type][i].forEach(function(e){e(a)})},r.prototype.getCcNameByNumber=function(e){if(!((e=Math.floor(e))>=0&&119>=e))throw new RangeError("The control change number must be between 0 and 119.");for(var t in s.MIDI_CONTROL_CHANGE_MESSAGES)if(s.MIDI_CONTROL_CHANGE_MESSAGES.hasOwnProperty(t)&&e===s.MIDI_CONTROL_CHANGE_MESSAGES[t])return t},r.prototype.getChannelModeByNumber=function(e){if(!((e=Math.floor(e))>=120&&status<=127))throw new RangeError("The control change number must be between 120 and 127.");for(var t in s.MIDI_CHANNEL_MODE_MESSAGES)if(s.MIDI_CHANNEL_MODE_MESSAGES.hasOwnProperty(t)&&e===s.MIDI_CHANNEL_MODE_MESSAGES[t])return t},r.prototype._parseSystemEvent=function(e){var t=e.data[0],n={target:this,data:e.data,timestamp:e.timeStamp};t===s.MIDI_SYSTEM_MESSAGES.sysex?n.type="sysex":t===s.MIDI_SYSTEM_MESSAGES.timecode?n.type="timecode":t===s.MIDI_SYSTEM_MESSAGES.songposition?n.type="songposition":t===s.MIDI_SYSTEM_MESSAGES.songselect?(n.type="songselect",n.song=e.data[1]):n.type=t===s.MIDI_SYSTEM_MESSAGES.tuningrequest?"tuningrequest":t===s.MIDI_SYSTEM_MESSAGES.clock?"clock":t===s.MIDI_SYSTEM_MESSAGES.start?"start":t===s.MIDI_SYSTEM_MESSAGES.continue?"continue":t===s.MIDI_SYSTEM_MESSAGES.stop?"stop":t===s.MIDI_SYSTEM_MESSAGES.activesensing?"activesensing":t===s.MIDI_SYSTEM_MESSAGES.reset?"reset":"unknownsystemmessage",this._userHandlers.system[n.type]&&this._userHandlers.system[n.type].forEach(function(e){e(n)})},i.prototype.send=function(e,t,n){if(!(e>=128&&255>=e))throw new RangeError("The status byte must be an integer between 128 (0x80) and 255 (0xFF).");void 0===t&&(t=[]),Array.isArray(t)||(t=[t]);var r=[];return t.forEach(function(e,t){var n=Math.floor(e);if(!(n>=0&&255>=n))throw new RangeError("Data bytes must be integers between 0 (0x00) and 255 (0xFF).");r.push(n)}),this._midiOutput.send([e].concat(r),parseFloat(n)||0),this},i.prototype.sendSysex=function(e,t,n){if(!s.sysexEnabled)throw new Error("Sysex message support must first be activated.");return n=n||{},e=[].concat(e),t.forEach(function(e){if(0>e||e>127)throw new RangeError("The data bytes of a sysex message must be integers between 0 (0x00) and 127 (0x7F).")}),t=e.concat(t,s.MIDI_SYSTEM_MESSAGES.sysexend),this.send(s.MIDI_SYSTEM_MESSAGES.sysex,t,this._parseTimeParameter(n.time)),this},i.prototype.sendTimecodeQuarterFrame=function(e,t){return this.send(s.MIDI_SYSTEM_MESSAGES.timecode,e,this._parseTimeParameter((t=t||{}).time)),this},i.prototype.sendSongPosition=function(e,t){return e=Math.floor(e)||0,this.send(s.MIDI_SYSTEM_MESSAGES.songposition,[e>>7&127,127&e],this._parseTimeParameter((t=t||{}).time)),this},i.prototype.sendSongSelect=function(e,t){if(t=t||{},!((e=Math.floor(e))>=0&&127>=e))throw new RangeError("The song number must be between 0 and 127.");return this.send(s.MIDI_SYSTEM_MESSAGES.songselect,[e],this._parseTimeParameter(t.time)),this},i.prototype.sendTuningRequest=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.tuningrequest,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendClock=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.clock,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendStart=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.start,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendContinue=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.continue,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendStop=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.stop,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendActiveSensing=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.activesensing,[],this._parseTimeParameter((e=e||{}).time)),this},i.prototype.sendReset=function(e){return this.send(s.MIDI_SYSTEM_MESSAGES.reset,void 0,this._parseTimeParameter((e=e||{}).time)),this},i.prototype.stopNote=function(e,t,n){if("all"===e)return this.sendChannelMode("allnotesoff",0,t,n);var r=64;return(n=n||{}).rawVelocity?!isNaN(n.velocity)&&n.velocity>=0&&n.velocity<=127&&(r=n.velocity):!isNaN(n.velocity)&&n.velocity>=0&&n.velocity<=1&&(r=127*n.velocity),this._convertNoteToArray(e).forEach(function(e){s.toMIDIChannels(t).forEach(function(t){this.send(t-1+(s.MIDI_CHANNEL_MESSAGES.noteoff<<4),[e,Math.round(r)],this._parseTimeParameter(n.time))}.bind(this))}.bind(this)),this},i.prototype.playNote=function(e,t,n){var r,i=64;if((n=n||{}).rawVelocity?!isNaN(n.velocity)&&n.velocity>=0&&n.velocity<=127&&(i=n.velocity):!isNaN(n.velocity)&&n.velocity>=0&&n.velocity<=1&&(i=127*n.velocity),r=this._parseTimeParameter(n.time),this._convertNoteToArray(e).forEach(function(e){s.toMIDIChannels(t).forEach(function(t){this.send(t-1+(s.MIDI_CHANNEL_MESSAGES.noteon<<4),[e,Math.round(i)],r)}.bind(this))}.bind(this)),!isNaN(n.duration)){n.duration<=0&&(n.duration=0);var a=64;n.rawVelocity?!isNaN(n.release)&&n.release>=0&&n.release<=127&&(a=n.release):!isNaN(n.release)&&n.release>=0&&n.release<=1&&(a=127*n.release),this._convertNoteToArray(e).forEach(function(e){s.toMIDIChannels(t).forEach(function(t){this.send(t-1+(s.MIDI_CHANNEL_MESSAGES.noteoff<<4),[e,Math.round(a)],(r||s.time)+n.duration)}.bind(this))}.bind(this))}return this},i.prototype.sendKeyAftertouch=function(e,t,n,r){var i=this;if(r=r||{},1>t||t>16)throw new RangeError("The channel must be between 1 and 16.");(isNaN(n)||0>n||n>1)&&(n=.5);var a=Math.round(127*n);return this._convertNoteToArray(e).forEach(function(e){s.toMIDIChannels(t).forEach(function(t){i.send(t-1+(s.MIDI_CHANNEL_MESSAGES.keyaftertouch<<4),[e,a],i._parseTimeParameter(r.time))})}),this},i.prototype.sendControlChange=function(e,t,n,r){if(r=r||{},"string"==typeof e){if(void 0===(e=s.MIDI_CONTROL_CHANGE_MESSAGES[e]))throw new TypeError("Invalid controller name.")}else if(!((e=Math.floor(e))>=0&&119>=e))throw new RangeError("Controller numbers must be between 0 and 119.");if(!((t=Math.floor(t)||0)>=0&&127>=t))throw new RangeError("Controller value must be between 0 and 127.");return s.toMIDIChannels(n).forEach(function(n){this.send(n-1+(s.MIDI_CHANNEL_MESSAGES.controlchange<<4),[e,t],this._parseTimeParameter(r.time))}.bind(this)),this},i.prototype._selectRegisteredParameter=function(e,t,n){var r=this;if(e[0]=Math.floor(e[0]),!(e[0]>=0&&e[0]<=127))throw new RangeError("The control65 value must be between 0 and 127");if(e[1]=Math.floor(e[1]),!(e[1]>=0&&e[1]<=127))throw new RangeError("The control64 value must be between 0 and 127");return s.toMIDIChannels(t).forEach(function(i){r.sendControlChange(101,e[0],t,{time:n}),r.sendControlChange(100,e[1],t,{time:n})}),this},i.prototype._selectNonRegisteredParameter=function(e,t,n){var r=this;if(e[0]=Math.floor(e[0]),!(e[0]>=0&&e[0]<=127))throw new RangeError("The control63 value must be between 0 and 127");if(e[1]=Math.floor(e[1]),!(e[1]>=0&&e[1]<=127))throw new RangeError("The control62 value must be between 0 and 127");return s.toMIDIChannels(t).forEach(function(i){r.sendControlChange(99,e[0],t,{time:n}),r.sendControlChange(98,e[1],t,{time:n})}),this},i.prototype._setCurrentRegisteredParameter=function(e,t,n){var r=this;if((e=[].concat(e))[0]=Math.floor(e[0]),!(e[0]>=0&&e[0]<=127))throw new RangeError("The msb value must be between 0 and 127");return s.toMIDIChannels(t).forEach(function(i){r.sendControlChange(6,e[0],t,{time:n})}),e[1]=Math.floor(e[1]),e[1]>=0&&e[1]<=127&&s.toMIDIChannels(t).forEach(function(i){r.sendControlChange(38,e[1],t,{time:n})}),this},i.prototype._deselectRegisteredParameter=function(e,t){var n=this;return s.toMIDIChannels(e).forEach(function(r){n.sendControlChange(101,127,e,{time:t}),n.sendControlChange(100,127,e,{time:t})}),this},i.prototype.setRegisteredParameter=function(e,t,n,r){var i=this;if(r=r||{},!Array.isArray(e)){if(!s.MIDI_REGISTERED_PARAMETER[e])throw new Error("The specified parameter is not available.");e=s.MIDI_REGISTERED_PARAMETER[e]}return s.toMIDIChannels(n).forEach(function(s){i._selectRegisteredParameter(e,n,r.time),i._setCurrentRegisteredParameter(t,n,r.time),i._deselectRegisteredParameter(n,r.time)}),this},i.prototype.setNonRegisteredParameter=function(e,t,n,r){var i=this;if(r=r||{},!(e[0]>=0&&e[0]<=127&&e[1]>=0&&e[1]<=127))throw new Error("Position 0 and 1 of the 2-position parameter array must both be between 0 and 127.");return t=[].concat(t),s.toMIDIChannels(n).forEach(function(s){i._selectNonRegisteredParameter(e,n,r.time),i._setCurrentRegisteredParameter(t,n,r.time),i._deselectRegisteredParameter(n,r.time)}),this},i.prototype.incrementRegisteredParameter=function(e,t,n){var r=this;if(n=n||{},!Array.isArray(e)){if(!s.MIDI_REGISTERED_PARAMETER[e])throw new Error("The specified parameter is not available.");e=s.MIDI_REGISTERED_PARAMETER[e]}return s.toMIDIChannels(t).forEach(function(i){r._selectRegisteredParameter(e,t,n.time),r.sendControlChange(96,0,t,{time:n.time}),r._deselectRegisteredParameter(t,n.time)}),this},i.prototype.decrementRegisteredParameter=function(e,t,n){if(n=n||{},!Array.isArray(e)){if(!s.MIDI_REGISTERED_PARAMETER[e])throw new TypeError("The specified parameter is not available.");e=s.MIDI_REGISTERED_PARAMETER[e]}return s.toMIDIChannels(t).forEach(function(r){this._selectRegisteredParameter(e,t,n.time),this.sendControlChange(97,0,t,{time:n.time}),this._deselectRegisteredParameter(t,n.time)}.bind(this)),this},i.prototype.setPitchBendRange=function(e,t,n,r){var i=this;if(r=r||{},!((e=Math.floor(e)||0)>=0&&127>=e))throw new RangeError("The semitones value must be between 0 and 127");if(!((t=Math.floor(t)||0)>=0&&127>=t))throw new RangeError("The cents value must be between 0 and 127");return s.toMIDIChannels(n).forEach(function(s){i.setRegisteredParameter("pitchbendrange",[e,t],n,{time:r.time})}),this},i.prototype.setModulationRange=function(e,t,n,r){var i=this;if(r=r||{},!((e=Math.floor(e)||0)>=0&&127>=e))throw new RangeError("The semitones value must be between 0 and 127");if(!((t=Math.floor(t)||0)>=0&&127>=t))throw new RangeError("The cents value must be between 0 and 127");return s.toMIDIChannels(n).forEach(function(s){i.setRegisteredParameter("modulationrange",[e,t],n,{time:r.time})}),this},i.prototype.setMasterTuning=function(e,t,n){var r=this;if(n=n||{},-65>=(e=parseFloat(e)||0)||e>=64)throw new RangeError("The value must be a decimal number larger than -65 and smaller than 64.");var i=Math.floor(e)+64,a=e-Math.floor(e),o=(a=Math.round((a+1)/2*16383))>>7&127,u=127&a;return s.toMIDIChannels(t).forEach(function(e){r.setRegisteredParameter("channelcoarsetuning",i,t,{time:n.time}),r.setRegisteredParameter("channelfinetuning",[o,u],t,{time:n.time})}),this},i.prototype.setTuningProgram=function(e,t,n){var r=this;if(n=n||{},!((e=Math.floor(e))>=0&&127>=e))throw new RangeError("The program value must be between 0 and 127");return s.toMIDIChannels(t).forEach(function(i){r.setRegisteredParameter("tuningprogram",e,t,{time:n.time})}),this},i.prototype.setTuningBank=function(e,t,n){var r=this;if(n=n||{},!((e=Math.floor(e)||0)>=0&&127>=e))throw new RangeError("The bank value must be between 0 and 127");return s.toMIDIChannels(t).forEach(function(i){r.setRegisteredParameter("tuningbank",e,t,{time:n.time})}),this},i.prototype.sendChannelMode=function(e,t,n,r){if(r=r||{},"string"==typeof e){if(!(e=s.MIDI_CHANNEL_MODE_MESSAGES[e]))throw new TypeError("Invalid channel mode message name.")}else if(!((e=Math.floor(e))>=120&&127>=e))throw new RangeError("Channel mode numerical identifiers must be between 120 and 127.");if(0>(t=Math.floor(t)||0)||t>127)throw new RangeError("Value must be an integer between 0 and 127.");return s.toMIDIChannels(n).forEach(function(n){this.send(n-1+(s.MIDI_CHANNEL_MESSAGES.channelmode<<4),[e,t],this._parseTimeParameter(r.time))}.bind(this)),this},i.prototype.sendProgramChange=function(e,t,n){var r=this;if(n=n||{},e=Math.floor(e),isNaN(e)||0>e||e>127)throw new RangeError("Program numbers must be between 0 and 127.");return s.toMIDIChannels(t).forEach(function(t){r.send(t-1+(s.MIDI_CHANNEL_MESSAGES.programchange<<4),[e],r._parseTimeParameter(n.time))}),this},i.prototype.sendChannelAftertouch=function(e,t,n){var r=this;n=n||{},e=parseFloat(e),(isNaN(e)||0>e||e>1)&&(e=.5);var i=Math.round(127*e);return s.toMIDIChannels(t).forEach(function(e){r.send(e-1+(s.MIDI_CHANNEL_MESSAGES.channelaftertouch<<4),[i],r._parseTimeParameter(n.time))}),this},i.prototype.sendPitchBend=function(e,t,n){var r=this;if(n=n||{},isNaN(e)||-1>e||e>1)throw new RangeError("Pitch bend value must be between -1 and 1.");var i=Math.round((e+1)/2*16383),a=i>>7&127,o=127&i;return s.toMIDIChannels(t).forEach(function(e){r.send(e-1+(s.MIDI_CHANNEL_MESSAGES.pitchbend<<4),[o,a],r._parseTimeParameter(n.time))}),this},i.prototype._parseTimeParameter=function(e){var t,n=parseFloat(e);return"string"==typeof e&&"+"===e.substring(0,1)?n&&n>0&&(t=s.time+n):n>s.time&&(t=n),t},i.prototype._convertNoteToArray=function(e){var t=[];return Array.isArray(e)||(e=[e]),e.forEach(function(e){t.push(s.guessNoteNumber(e))}),t},e.exports?e.exports=s:t.WebMidi||(t.WebMidi=s)}(n)});class p{constructor(){this.name="web_audio",this.prepared=!1,this.midi=!1,this.sources=[],this.keys={}}source(e){return this.sources[e]}get_context(){return this.context}is_prepared(){return this.prepared}componentDidLoad(){this.connect_debugger()}async connect_the_world(){return this.connect_context(),this.gain=this.context.createGain(),this.connect_visualizers(),this.connect_sources(),this.connect_midi(),this.prepared=!0,!0}connect_context(){this.context=window.webkitAudioContext?new webkitAudioContext:new AudioContext,this.log("Connected to this.context")}connect_sources(){this.build_sources()}async build_sources(){this.log("Building sources"),this._sources=Array.from(this.element.querySelectorAll("web-audio-source")),this.externalFiles=[],this._sources.forEach((e,t)=>{this.log(`(${t}) Preparing ${e.name}`),this.sources[e.name]=e,new c(this.context,[e.src],t=>{this.cache_sources(t,e)}).load()},this)}async cache_sources(e,t){await o(20),e.forEach(e=>{this.log(`Caching ${t.name}`),this.midi&&(this.log(`Assigned ${t.name} to midi key ${t.midikey}, channel ${t.midichannel}`),null==this.keys[t.midichannel]&&(this.keys[t.midichannel]=[]),this.keys[t.midichannel][t.midikey]=t),this._currentSource=t,this._currentSource.assignBuffer(this,e),this.log(`Source ${t.name} is ready`)}),this._currentSource=null}async connect_visualizers(){await o(20),this.visualizers=Array.from(document.querySelectorAll(`web-audio-visualizer[for="${this.name}"]`)),this.visualizers?(this.log("Attaching visualizers"),this.visualizers.forEach((e,t)=>{e=e.connect(this.context,0===t?this.context.destination:this.previousVisualizer.analyser),this.previousVisualizer=e})):this.log(`No visualizers for ${this.name}`),this.gain.connect(this.visualizers.length>=1?this.previousVisualizer.analyser:this.context.destination)}connect_debugger(){this.debugger=document.querySelector(`web-audio-debugger[for="${this.name}"]`),this.log("Connected debugger")}log(e){this.debugger&&this.debugger.addHistory(e)}connect_midi(){this.midi&&d.enable(e=>{this.log(e?"Midi couldn't be enabled."+e:"Midi is enabled");var t=d.inputs[0];t&&(t.addListener("noteon","all",e=>{this.log(`KEY: Channel: ${e.channel}, Note: ${e.note.number}, Name: ${e.note.name}, Oct: ${e.note.octave}`),this.keys[e.channel]&&(this.keys[e.channel][e.note.number].gain().value=e.data[2]/175,this.keys[e.channel][e.note.number].play())}),t.addListener("pitchbend","all",e=>{this.log(`PITCH: Channel: ${e.channel}, Value: ${e.value}`)}),t.addListener("controlchange","all",e=>{this.log(`CTRL: Channel: ${e.channel}, controller: ${e.controller.number}, Value: ${e.value}`);var t=new CustomEvent("midi-controller-update",{detail:e});document.dispatchEvent(t)}),this.log("Listeners added for notes, pitch bend, and controllers."))})}static get is(){return"web-audio"}static get properties(){return{_currentSource:{state:!0},_sources:{state:!0},autoplay:{type:"Any",attr:"autoplay"},connect_the_world:{method:!0},context:{state:!0},debugger:{state:!0},element:{elementRef:!0},externalFiles:{state:!0},gain:{state:!0},get_context:{method:!0},is_prepared:{method:!0},keys:{state:!0},midi:{type:"Any",attr:"midi"},name:{type:String,attr:"name"},prepared:{state:!0},previousVisualizer:{state:!0},source:{method:!0},sources:{state:!0},visualizerNodes:{state:!0},visualizers:{state:!0}}}}class f{constructor(){this.inert=!1,this.midikey=0,this.midichannel=1,this.status="paused",this.effectsvolume=100,this.effects=[],this.duration=0,this.startTime=0,this.pausedTime=0,this.elapsedTime=0,this.playing=!1}getBuffer(){return this.buffer}webAudio(){return this.webAudioWrapper}gain(e="wet"){return"wet"===e?this.wetGain:"dry"===e?this.dryGain:"channel"===e?this.channelGain:void 0}getDuration(){return this.duration}currentTime(){let e=0;return this.pausedTime?e=this.pausedTime:this.startTime&&(e=this.context.currentTime-this.startTime),e>=this.duration&&(e=this.duration),e}prepare(){this.inert||(this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.wetGain?(this.wetGain.gain.value=this.effectsvolume/100,this.dryGain.gain.value=Math.abs((this.effectsvolume-100)/100)):this.dryGain.gain.value=1,this.wetGain&&this.source.connect(this.wetGain),this.source.connect(this.dryGain),this.duration=this.source.buffer.duration)}play(){if(this.inert)throw"Cannot play inert media.";this.prepare(),this.source.start(0,this.pausedTime),this.startTime=this.context.currentTime-this.pausedTime,this.pausedTime=0,this.playing=!0,this.tick(),a(()=>{this.tick()})}skipTo(e){this.stop(),this.pausedTime=e/1e3,this.play()}pause(){this.elapsedTime=this.context.currentTime-this.startTime,this.stop(),this.pausedTime=this.elapsedTime,this.playing=!1}toggle(){this.playing?this.pause():this.play()}stop(){this.source&&(this.source.disconnect(),this.source.stop()),this.source=null,this.pausedTime=0,this.startTime=0,this.playing=!1}tick(){this.timeupdate.emit({time:this.currentTime(),duration:this.duration}),this.source&&a(()=>{this.tick()})}assignBuffer(e,t){if(this.webAudioWrapper=e.element,this.context=e.context,this.buffer=t,!this.inert){if(this.masterGain=e.gain,this.channelGain=this.context.createGain(),this.prepareEffects(),Object.keys(this.effects).length>0){this.wetGain=this.context.createGain();let e="";Object.keys(this.effects).reverse().forEach((t,n)=>{0===n?this.wetGain.connect(this.effects[t]):this.effects[e].connect(this.effects[t]),e=t}),this.effects[e].connect(this.channelGain)}this.dryGain=this.context.createGain(),this.dryGain.connect(this.channelGain),this.channelGain.connect(this.masterGain)}}prepareEffects(){if("WEB-AUDIO"!==this.element.parentElement.nodeName){let e=this.element.parentElement;for(;"WEB-AUDIO"!==e.nodeName;)this.effects[e.getAttribute("name")]=e.attachEffect(this.context,this.element),e=e.parentElement}}static get is(){return"web-audio-source"}static get encapsulation(){return"shadow"}static get properties(){return{assignBuffer:{method:!0},buffer:{state:!0},channelGain:{state:!0},context:{state:!0},dryGain:{state:!0},duration:{state:!0},effects:{state:!0},effectsvolume:{type:Number,attr:"effectsvolume",reflectToAttr:!0,mutable:!0},elapsedTime:{state:!0},element:{elementRef:!0},entry:{state:!0},gain:{method:!0},getBuffer:{method:!0},getDuration:{method:!0},inert:{type:Boolean,attr:"inert"},masterGain:{state:!0},midichannel:{type:Number,attr:"midichannel",reflectToAttr:!0,mutable:!0},midikey:{type:Number,attr:"midikey",reflectToAttr:!0,mutable:!0},name:{type:String,attr:"name",reflectToAttr:!0,mutable:!0},pause:{method:!0},pausedTime:{state:!0},play:{method:!0},playing:{type:Boolean,attr:"playing",mutable:!0},prepare:{method:!0},skipTo:{method:!0},source:{state:!0},src:{type:String,attr:"src",reflectToAttr:!0,mutable:!0},startTime:{state:!0},status:{state:!0},stop:{method:!0},toggle:{method:!0},webAudio:{method:!0},webAudioWrapper:{state:!0},wetGain:{state:!0}}}static get events(){return[{name:"timeupdate",method:"timeupdate",bubbles:!0,cancelable:!0,composed:!0}]}}export{u as StellarInterview,h as StellarProgress,p as WebAudio,l as WebAudioDebugger,f as WebAudioSource};